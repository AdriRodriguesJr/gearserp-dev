version: '3.8'

services:
  # Banco de dados
  db:
    image: postgres:13
    container_name: gearserp-db
    environment:
      POSTGRES_USER: arodrigues
      POSTGRES_PASSWORD: 123456
      POSTGRES_DB: gearserp
    volumes:
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gearserp-network
    restart: unless-stopped

  # Backend (API)
  backend:
    build: ./backend
    container_name: gearserp-backend
    environment:
      - NODE_ENV=production
      - DB_HOST=db
      - DB_USER=arodrigues
      - DB_PASSWORD=123456
      - DB_NAME=gearserp
      - DB_PORT=5432
    networks:
      - gearserp-network
    depends_on:
      - db
    restart: unless-stopped

  # Frontend (React/Vite)
  frontend:
    build: ./frontend
    container_name: gearserp-frontend
    networks:
      - gearserp-network
    restart: unless-stopped

  # Reverse Proxy (Nginx)
  reverse-proxy:
    build: ./nginx
    container_name: gearserp-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/conf:/etc/letsencrypt  # Certificados SSL
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf  # Configuração do Nginx
    networks:
      - gearserp-network
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

  # Certbot (Gerador de Certificados SSL)
  certbot:
    image: certbot/certbot
    container_name: gearserp-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/data:/var/www/certbot  # Pasta para validação do domínio
    command: certonly --webroot --webroot-path=/var/www/certbot --non-interactive --agree-tos --email adriano.rodrigues.junior01@gmail.com -d gearserp.space -d www.desenvolvimento.gearserp.space
    networks:
      - gearserp-network
    depends_on:
      - reverse-proxy

# Configuração de redes
networks:
  gearserp-network:
    driver: bridge

# Volumes persistentes
volumes:
  postgres_data:
  certbot: